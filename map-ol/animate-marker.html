<!DOCTYPE html>
<html>
<head>
    <title>Marker Animation</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
</head>
<body>
<div id="map" class="map"></div>
<label for="speed">
    speed:&nbsp;
    <input id="speed" type="range" min="10" max="999" step="10" value="60">
</label>
<button id="start-animation">Start Animation</button>
<script>
    let lineWkt = 'LINESTRING(113.06350206875035 30.254673968865802,113.13765978359412 30.302112148806742,113.1816050960941 30.394550592712974,113.2585093929691 30.4182386865442,113.28322863125034 30.508200993296683,113.38759874843785 30.48216781811381,113.4397838070316 30.572071056037302,113.5771129085941 30.522397970345537,113.6045787289066 30.631172526814595,113.7693736507816 30.576800500363632,113.79134630703162 30.64771447542479,113.86001085781285 30.631172526814595,113.9121959164066 30.678427730100992,114.0055797054691 30.694961592577897,114.08523058437537 30.74454618523731,114.2198131039066 30.725659823382884,114.27474474453162 30.737464233328467,114.4670054867191 30.737464233328467,114.62905382656284 30.739824941808124,114.72793077968784 30.770508887431916,114.82680773281285 30.749267197275714,114.91744493984412 30.770508887431916,115.06301378750034 30.704408242599413,115.18386339687534 30.676065518626245,115.25802111171909 30.614627749782613,115.31569933437535 30.529495681274454,115.34316515468785 30.430080577899105,115.39260363125035 30.29974078450924,115.4722545101566 30.254673968865802,115.40908312343785 30.159728868173275,115.26626085781284 30.124100853525547,115.22780870937534 30.181099500569744,115.2030894710941 30.278395925274182,115.08223986171912 30.411132861877547,114.99709581875035 30.437185022741687,114.7471568539066 30.460862767177787,114.60982775234409 30.508200993296683,114.56313585781284 30.522397970345537,114.3846080257816 30.550785702826758,114.18685411953159 30.576800500363632,114.1484019710941 30.574435807030525,113.98635363125037 30.517665875043676,113.84078478359407 30.48926846581945,113.78859972500032 30.470332254156517,113.63753771328157 30.396919660707653,113.46450304531282 30.359007679141996,113.36013292812532 30.29262634751025,113.31069445156282 30.207212868152197,113.25301622890657 30.126476454678652,113.34090685390657 30.08133026212407,113.43429064296906 30.036163454739395,113.54140734218782 30.093212838540538,113.64852404140657 30.176350871608733,113.6924693539066 30.230946282263048,113.78619770508166 30.278544704622746,113.99925080864843 30.320720291120523,114.13108674614841 30.356277116057385,114.24095002739845 30.36575675458414,114.40849153130466 30.304122687610842,114.57053987114843 30.313607376679144,114.73258821099219 30.256685479823716,114.86442414849218 30.183112516566325,114.99626008599218 30.230585243800277,115.08415071099218 30.102356363147663,115.11161653130468 29.983477374003485,114.90287629692969 29.94302604331247,114.63096467583594 30.016777867774948,114.52934114067968 29.957304863468565,114.29789408276197 29.968464085651547,114.15232523510574 30.0612159763365,113.87492044994947 29.994633656549425,113.78428324291822 29.947047490610373,113.65519388744947 29.968464085651547,113.59751566479322 29.737398027614034,114.04520853588697 29.737398027614034,114.36655863354324 29.730243135533257,114.66868265698072 29.718317181453344,115.07243021557447 29.758859641352103,115.34434183666824 29.80653566094567,115.52012308666822 29.906581337723722,115.6107602936995 30.01128342873629,115.58491499992438 30.41899846145371,115.56568892570563 30.544448343952965,115.49427779289314 30.657975363286425,115.3871610936744 30.721746735997627,115.29103072258063 30.78311636680513,115.10700972648688 30.839730523853603,114.76094039054938 30.91280773438615,114.53297408195562 30.934013256486523,114.11824019523688 30.945792070318006,113.9259794530494 30.91280773438615,113.79689009758064 30.823221507930157,113.62660201164313 30.832655578974283,113.44807417961187 30.827938659330087,113.39588912101814 30.728829842991004,113.30799849601814 30.792554376207676,113.06350206875035 30.254673968865802)';
    let format = new ol.format.WKT();
    let feature = format.readFeature(lineWkt, {
        dataProjection: 'EPSG:4326',
        featureProjection: 'EPSG:900913'
    });
    let routeCoords = feature.getGeometry().getCoordinates();
    let routeLength = routeCoords.length;

    let vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [feature]
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 6, color: [237, 212, 0, 0.8]
            })
        }),
        zIndex: 101
    });

    let markerStyle = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 7,
            snapToPixel: false,
            fill: new ol.style.Fill({color: 'black'}),
            stroke: new ol.style.Stroke({
                color: 'white', width: 2
            })
        })
    });

    let map = new ol.Map({
        target: document.getElementById('map'),
        loadTilesWhileAnimating: true,
        view: new ol.View({
            center: [12722846.520, 3580460.490],
            zoom: 8,
            minZoom: 2,
            maxZoom: 19
        }),
        layers: [
            vectorLayer,
            new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'http://192.168.0.207/tile/ni/r/{z}/{x}/{y}.png',
                    tileSize: [512, 512]
                })
            }),
            new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'http://192.168.0.207/tile/ni/t/{z}/{x}/{y}.png',
                    tileSize: [512, 512]
                })
            })
        ]
    });

    let now = new Date().getTime();// 关键
    let moveFeature = function(event) {
        let speed = 200;
        let vectorContext = event.vectorContext;
        let frameState = event.frameState;
        let elapsedTime = frameState.time - now;
        let index = Math.round(speed * elapsedTime / 100000);
        if (index >= routeLength) {
            return;
        }
        let currentPoint = new ol.geom.Point(routeCoords[index]);
        let feature = new ol.Feature(currentPoint);
        vectorContext.drawFeature(feature, markerStyle);
        map.render();
    };
    map.on('postcompose', moveFeature);
    map.render();

</script>
</body>
</html>